## 订阅与发布

  相关命令：
1. PSUBSCRIBE psubscribe 订阅一个或多个符合给定模式的频道
2. PUBSUB pubsub 查看订阅与发布系统状态
3. PUBLISH publish 将信息发送到指定的频道
4. PUNSUBSCRIBE punsubscribe 退订所有给定模式的频道
5. SUBSCRIBE subscribe 订阅给定的一个或多个频道的信息
6. UNSUBSCRIBE unsubcrice 指退订给定的频道

## pipeline
redis 客户端执行一条命令分 4 个过程： 发送命令、命令排队、命令执行、返回结果。使用pipeline可以批量请求，批量返回结果，执行速度比逐条执行要快。

使用pipeline组装的命令个数不能太多，不然数据量过大，增加客户端的等待时间，还可能造成网络阻塞，可以将大量命令的拆分多个小的pipeline命令完成。

原生批命令（mset 和 mget）与pipeline对比：
1. 原生批命令是原子性，pipeline是非原子性。pipeline 命令中途异常退出，之前执行成功的命令不会回滚。 
2. 原生批命令只有一个命令，但pipeline支持多命令

## 单线程原理
Redis单线程指的是网络请求模块使用了一个线程，其他模块仍用了多个线程。并不是一个线程完成了所有功能。原理上，其采用了利用epoll的多路复用特性，因此可以采用单线程处理其网络请求。

## redis与memcache的区别
1. redis处理网络请求采用单线程模型，而memcache采用多线程异步IO的方式
2. redis支持数据持久化，memcache不支持
3. redis支持的数据格式比memcache更多

## 主从
  概念: 在redis集群中master节点和slave节点数据同步的机制。将写入redis服务器的数据复制到其他redis服务器里面实现数据同步。master节点负责写操作，slave节点负责读操作。 
  
  原理: 主库（Master）节点和从库（Slave）节点两个角色。从节点服务启动会连接主库，并向主库发送SYNC命令。主节点收到同步命令，启动持久化工作，工作执行完成后，主节点将传送整个数据库文件到从库，从节点接收到数据库文件数据之后将数据进行加载。此后，主节点继续将所有已经收集到的修改命令，和新的修改命令依次传送给从节点，从节点依次执行，从而达到最终的数据同步。
  
  通过这种方式，可以使写操作作用于主库，而读操作作用于从库，从而达到读写分离。
  
  模式: 全量复制(sync)和增量复制(psync)

  全量复制：用于初次复制或其他无法进行部分复制的情况，将主节点中的所有数据都发送给从节点，是一个非常重型的操作。  
  增量复制: 用于网络中断等情况后的复制，只将中断期间主节点执行的写命令发送给从节点，与全量复制相比更加高效，需要注意的是，如果网络中断时间过长，导致主节点没有能够完整地保存中断期间执行地写命令，则无法进行部分复制，仍使用全量复制。

## 哨兵模式
客户端连接 Redis 的时候，先连接哨兵，哨兵会告诉客户端 Redis 主节点的地址，然后客户端连接上 Redis 并进行后续的操作。
  功能：  
  
  监控（Monitoring）：哨兵会不断地检查主节点master和从节点slave是否运作正常。  
  
  自动故障转移（Automatic failover）：当主节点master不能正常工作时，哨兵会开始自动故障转移操作，它会将失效主节点的其中一个从节点升级为新的主节点，并让其他从节点改为复制新的主节点。
  
  配置提供者（Configuration provider）：客户端在初始化时，通过连接哨兵来获得当前Redis服务的主节点地址。  
  
  通知（Notification）：哨兵可以将故障转移的结果发送给客户端。  


每个哨兵每隔一段时间 ping 主服务器master， slave和其他哨兵。

客户端通过哨兵，由哨兵提供可供服务的redis master节点。

哨兵只需要配master节点，会自动寻找其对应的slave节点。

监控同一master节点的哨兵会自动互联，组成哨兵网络，当任一哨兵发现master连接不上，即开会投票，投票半数以上决定Master下线，并从slave节点中选取master节点。

  注: 哨兵也是一台redis服务器，只是不提供数据服务

### 哨兵选举
1. 第一个发现该master挂了的哨兵，向每个哨兵发送命令，让对方选举自己成为领头哨兵
2. 其他哨兵如果没有选举过他人，就会将这一票投给第一个发现该master挂了的哨兵
3. 第一个发现该master挂了的哨兵如果发现由超过一半哨兵投给自己，并且其数量也超过了设定的quoram参数，那么该哨兵就成了领头哨兵
4. 如果多个哨兵同时参与这个选举，那么就会重复该过程，知道选出一个领头哨兵

选出领头哨兵后，就开始了故障修复，会从选出一个从数据库作为新的master